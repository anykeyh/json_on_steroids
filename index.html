<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.36.1">
<meta name="crystal_docs.project_version" content="HEAD">
<meta name="crystal_docs.project_name" content="json_on_steroids">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="json_on_steroids">
  <title>json_on_steroids HEAD</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          json_on_steroids
        </a>
      </h1>

      <span class="project-version">
        HEAD
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="json_on_steroids/Clear" data-name="clear">
      <a href="Clear.html">Clear</a>
      
        <ul>
  
  <li class="parent " data-id="json_on_steroids/Clear/Model" data-name="clear::model">
      <a href="Clear/Model.html">Model</a>
      
        <ul>
  
  <li class="parent " data-id="json_on_steroids/Clear/Model/Converter" data-name="clear::model::converter">
      <a href="Clear/Model/Converter.html">Converter</a>
      
        <ul>
  
  <li class="parent " data-id="json_on_steroids/Clear/Model/Converter/JSON" data-name="clear::model::converter::json">
      <a href="Clear/Model/Converter/JSON.html">JSON</a>
      
        <ul>
  
  <li class=" " data-id="json_on_steroids/Clear/Model/Converter/JSON/OnSteroidConverter" data-name="clear::model::converter::json::onsteroidconverter">
      <a href="Clear/Model/Converter/JSON/OnSteroidConverter.html">OnSteroidConverter</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="json_on_steroids/JSON" data-name="json">
      <a href="JSON.html">JSON</a>
      
        <ul>
  
  <li class=" " data-id="json_on_steroids/JSON/Any" data-name="json::any">
      <a href="JSON/Any.html">Any</a>
      
    </li>
  
  <li class="parent " data-id="json_on_steroids/JSON/OnSteroids" data-name="json::onsteroids">
      <a href="JSON/OnSteroids.html">OnSteroids</a>
      
        <ul>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/Access" data-name="json::onsteroids::access">
      <a href="JSON/OnSteroids/Access.html">Access</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/AuthorizedSetTypes" data-name="json::onsteroids::authorizedsettypes">
      <a href="JSON/OnSteroids/AuthorizedSetTypes.html">AuthorizedSetTypes</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/Dirty" data-name="json::onsteroids::dirty">
      <a href="JSON/OnSteroids/Dirty.html">Dirty</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/Exception" data-name="json::onsteroids::exception">
      <a href="JSON/OnSteroids/Exception.html">Exception</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/InPlace" data-name="json::onsteroids::inplace">
      <a href="JSON/OnSteroids/InPlace.html">InPlace</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/KeyNotFoundException" data-name="json::onsteroids::keynotfoundexception">
      <a href="JSON/OnSteroids/KeyNotFoundException.html">KeyNotFoundException</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/MergeOperations" data-name="json::onsteroids::mergeoperations">
      <a href="JSON/OnSteroids/MergeOperations.html">MergeOperations</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/NotAnArray" data-name="json::onsteroids::notanarray">
      <a href="JSON/OnSteroids/NotAnArray.html">NotAnArray</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/NotAnObject" data-name="json::onsteroids::notanobject">
      <a href="JSON/OnSteroids/NotAnObject.html">NotAnObject</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/RawWrappedValue" data-name="json::onsteroids::rawwrappedvalue">
      <a href="JSON/OnSteroids/RawWrappedValue.html">RawWrappedValue</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/Searchable" data-name="json::onsteroids::searchable">
      <a href="JSON/OnSteroids/Searchable.html">Searchable</a>
      
    </li>
  
  <li class=" " data-id="json_on_steroids/JSON/OnSteroids/WrappedPrimitive" data-name="json::onsteroids::wrappedprimitive">
      <a href="JSON/OnSteroids/WrappedPrimitive.html">WrappedPrimitive</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="jsonon-steroids" class="anchor" href="#jsonon-steroids">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>JSON::OnSteroids</h1>

<p><a href="https://travis-ci.org/anykeyh/json_on_steroids/"><img src="https://travis-ci.org/anykeyh/json_on_steroids.svg" alt="Build Status"/></a>
<a href="https://anykeyh.github.io/json_on_steroids/"><img src="https://img.shields.io/badge/docs-available-brightgreen.svg" alt="API Docs"/></a></p>

<h2><a id="description" class="anchor" href="#description">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Description</h2>

<p><code>json_on_steroids</code> provides powerful JSON document transformation and edition
with some advanced features to navigate through the keys.</p>

<p>Basically, it can be seen as a <code><a href="JSON/Any.html">JSON::Any</a></code> object on steroid.</p>

<p>The current Crystal stdlib JSON implementation is made of immutable structures.
While being performant, it turns out dealing with JSON blob with a fully typed language can be really painful.</p>

<p>Transforming JSON to hash or array is often not enough and lead to obscure type errors and ninja type castings.</p>

<p><code><a href="JSON/OnSteroids.html">JSON::OnSteroids</a></code> trades some performance to offers functionalities:</p>

<ul><li>Mutate or construct from zero a JSON schema easily</li><li>Pass Hash, Array, NamedTuple etc... as parameters of keys without hassle</li><li>Check whether a schema is dirty (has changed) or not</li><li>Errors telling you what key/sub-schema is wrong at runtime</li><li>Out of the box support of <code>Time</code>, which happens to be common in JSON</li><li>Interface well with PostgreSQL's JSONB column and <a href="https://github.com/anykeyh/clear">Clear ORM</a></li></ul>

<h2><a id="example" class="anchor" href="#example">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Example</h2>

<h3><a id="build-a-jsonon-steroids-structure" class="anchor" href="#build-a-jsonon-steroids-structure">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Build a JSON::OnSteroids structure:</h3>

<pre><code class="language-crystal">  <span class="c"># build from scratch (empty object `{}`)</span>
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span>

  <span class="c"># build from initial json</span>
  json <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="s">%&lt;{&quot;a&quot;: 1, &quot;b&quot;: 2}&gt;</span>).on_steroids!
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span>(<span class="t">JSON</span>.parse(<span class="s">%&lt;{&quot;a&quot;: 1, &quot;b&quot;: 2}&gt;</span>))

  <span class="c"># build from initial hash and named tuples:</span>
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span> a: <span class="n">1</span>, b: <span class="n">2</span>
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span>({<span class="s">&quot;a&quot;</span> => <span class="n">1</span>, <span class="s">&quot;b&quot;</span> => <span class="n">2</span>})

  <span class="c"># build from empty object json</span>
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span>

  <span class="c"># build array</span>
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span> [<span class="n">1</span>,<span class="n">2</span>,<span class="n">3</span>]

  <span class="c"># build a value (is it useful?)</span>
  json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span> <span class="s">&quot;a value&quot;</span></code></pre>

<h3><a id="exporting-to-json" class="anchor" href="#exporting-to-json">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Exporting to json</h3>

<pre><code class="language-crystal">  json.to_json <span class="c">#obvious enough</span></code></pre>

<h3><a id="getter-setters" class="anchor" href="#getter-setters">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Getter / setters</h3>

<p>The API of <code><a href="JSON/Any.html">JSON::Any</a></code> for getters are supported. So, as with <code><a href="JSON/Any.html">JSON::Any</a></code>, you
can access to a specific field by using <code>[]</code> then casting using <code>as_xxx</code> where
<code>xxxx</code> can be <code>i</code>, <code>s</code>, <code>b</code> etc...</p>

<p>Basically, a <code><a href="JSON/OnSteroids.html">JSON::OnSteroids</a></code> can be passed wherever a <code><a href="JSON/Any.html">JSON::Any</a></code> object is
required, while it's not true in the other way.</p>

<p><code><a href="JSON/OnSteroids.html">JSON::OnSteroids</a></code> add setters:</p>

<pre><code class="language-crystal">json <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="s">%&lt;{&quot;type&quot;: &quot;event&quot;, &quot;type&quot;: &quot;favorites_numbers&quot;,&quot;data&quot;: [1,2,3,4] }&gt;</span>).on_steroids!

json[<span class="s">&quot;data&quot;</span>][<span class="n">0</span>] <span class="o">=</span> <span class="s">&quot;Hello&quot;</span>

json.to_json <span class="c"># =&gt; {&quot;type&quot;: &quot;event&quot;, &quot;type&quot;: &quot;favorites_numbers&quot;,&quot;data&quot;: [&quot;Hello&quot;,2,3,4] }</span>

<span class="c"># Automatically import from named tuples, arrays and hashes</span>

from_tuple <span class="o">=</span> {
  <span class="k">type</span>: <span class="s">&quot;collection&quot;</span>,
  pages: {
    count: <span class="n">3</span>,
    current: <span class="n">2</span>,
    next_page: <span class="s">&quot;http://myservice/api/collection?page=3&quot;</span>
  },
  data: [
    { <span class="k">type</span>: <span class="s">&quot;_user&quot;</span>, id: <span class="n">1</span> },
    { <span class="k">type</span>: <span class="s">&quot;_user&quot;</span>, id: <span class="n">2</span> }
  ]
}

json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span>.<span class="k">new</span>(from_tuple)</code></pre>

<h3><a id="digging" class="anchor" href="#digging">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Digging</h3>

<p>Digging allows you to fetch a key in your JSON schema:</p>

<pre><code class="language-crystal">  json <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="s">%&lt;{&quot;type&quot;: &quot;event&quot;, &quot;is&quot;: &quot;favorites_numbers&quot;,&quot;data&quot;: [1,2,3,4] }&gt;</span>).on_steroids!
  puts json.dig(<span class="s">&quot;data.1&quot;</span>).as_i <span class="c">#=&gt; 2</span></code></pre>

<p>Two flavors of dig method exists:
<code>dig(string)</code> which throw an error if the key is not found / schema doesn't match and <code>dig?(string)</code> which return
<code>nil</code> in case it can't dig (the key doesn't match).</p>

<h3><a id="set-remove-in-place" class="anchor" href="#set-remove-in-place">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Set / remove in place</h3>

<p>Digging can be combined with set in place and remove feature:</p>

<pre><code class="language-crystal">  json <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="s">%&lt;{&quot;other&quot;: {&quot;counter&quot;: 123}}&gt;</span>).on_steroids!

  json.dig(<span class="s">&quot;other.counter&quot;</span>).set(<span class="o">&amp;</span>.as_i.<span class="o">+</span>(<span class="n">1</span>)) <span class="c"># Add 1 to the counter</span>
  puts json.to_json <span class="c"># =&gt; {&quot;other&quot;: {&quot;counter&quot;: 124}}</span>

  json.dig(<span class="s">&quot;other.counter&quot;</span>).remove
  puts json.to_json <span class="c"># =&gt; {&quot;other&quot;: {}}</span></code></pre>

<h3><a id="introspection" class="anchor" href="#introspection">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Introspection</h3>

<p><code><a href="JSON/OnSteroids.html">JSON::OnSteroids</a></code> objects are aware of few states:</p>

<ul><li>You can reverse traversing by calling <code>json.parent</code></li><li>How deep they are in the document by calling <code>json.depth</code></li><li>If they are dirty (e.g. they mutate) by calling <code>json.dirty?</code></li><li>In case they belongs to a map or an array,
  which key they are mapped to by calling <code>json.key</code></li><li>The full path of an element can be found by calling <code>json.path</code></li></ul>

<p><code><a href="JSON/OnSteroids.html">JSON::OnSteroids</a></code> objects can introspect about their mutation state.
  It also can return the schema with the only mutated elements:</p>

<pre><code class="language-crystal">  json <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="s">%&lt;{&quot;key&quot;: 1, &quot;other&quot;: {&quot;counter&quot;: 123}}&gt;</span>).on_steroids!

  json[<span class="s">&quot;other&quot;</span>][<span class="s">&quot;counter&quot;</span>] <span class="o">=</span> <span class="n">543</span>

  json.dirty? <span class="c">#=&gt; true</span>

  puts json.dirty_only.to_json <span class="c"># =&gt; {&quot;other&quot;: {&quot;counter&quot;: 543}}</span></code></pre>

<p>This is useful for:</p>

<ul><li>Snapshot between your JSON document</li><li>Merge-able noSQL databases will crunch this in no time \o/</li></ul>

<p>You can clean a dirty object by calling <code>clean!</code> on it:</p>

<pre><code class="language-crystal">json.dirty? <span class="c"># =&gt; true</span>
json.clean! <span class="c">#</span>
json.dirty? <span class="c"># =&gt; false</span></code></pre>

<h2><a id="qa" class="anchor" href="#qa">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Q&A</h2>

<h3><a id="performance-tradeoff" class="anchor" href="#performance-tradeoff">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Performance tradeoff</h3>

<p><code><a href="JSON/OnSteroids.html">JSON::OnSteroids</a></code> works by encapsulating all values in a wrapper class. Performance wise, it
creates new object everytime you mutate a value. Moreover, each key keep a reference
to the parent and a dirty boolean field.</p>

<p>In term of CPU, it has a small overhead, usually negligible. In terms of memory,
the overhead of the wrapper is 17 bytes per fields, array items comprised.
It can then become voluminous in case of processing large JSON of few megabytes.</p>

<p>In case you dealing with very-large JSON or are in a memory-constrainted
environnement, I would recommend you to use data mapping or serialization strategies.</p>

<h2><a id="interfacing-with-libraries" class="anchor" href="#interfacing-with-libraries">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Interfacing with libraries</h2>

<h3><a id="clear" class="anchor" href="#clear">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Clear</h3>

<p>Currently, <code>json_on_steroids</code> interface with <a href="https://github.com/anykeyh/clear">Clear</a>,
as that's how I use it.</p>

<p>Add this optional requirement to use it into clear</p>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;json_on_steroids/ext/clear&quot;</span></code></pre>

<p>Now your jsonb columns are mapped :).</p>

<pre><code class="language-crystal">  column jsonb : <span class="t">JSON</span><span class="t">::</span><span class="t">OnSteroids</span></code></pre>

<p>Usage of <code>dirty?</code> allows the edition in place of your json:</p>

<pre><code class="language-crystal">  mdl <span class="o">=</span> <span class="t">Model</span>.query.first!
  mdl.jsonb[<span class="s">&quot;my&quot;</span>][<span class="s">&quot;content&quot;</span>] <span class="o">=</span> <span class="s">&quot;is awesome&quot;</span>
  mdl.changed? <span class="c"># =&gt; true</span>
  mdl.update_h <span class="c">#=&gt; {&quot;jsonb&quot; =&gt; JSON::OnSteroids}</span>
  mdl.save!</code></pre>

<p>If you want to interface in another ORM or libraries, pull request are welcome !</p>

<h2><a id="future-on-this-shard" class="anchor" href="#future-on-this-shard">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Future on this shard</h2>

<p>Currently not implemented but planned:</p>

<h3><a id="searching" class="anchor" href="#searching">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Searching</h3>

<p><strong>WIP: Not implemented yet.</strong></p>

<p>You can <code>search</code> through the document a key responding to a specific rule:</p>

<pre><code class="language-crystal">puts <span class="s">&quot;Events from facebook or google:&quot;</span>

<span class="c"># search every elements which contains the keys `type` and `provider`:</span>
json.search(<span class="k">type</span>: <span class="s">&quot;event&quot;</span>, provider: <span class="s">/^(facebook|google)$/</span>){ <span class="o">|</span>evt<span class="o">|</span>
  puts evt[<span class="s">&quot;url&quot;</span>]
}</code></pre>
</div>
</body>
</html>
